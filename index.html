<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ü™µ Tabl√≥n del Clan - Pax Dei</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1>ü™µ Tabl√≥n del Clan - Pax Dei</h1>

    <!-- Men√∫ de usuario (se muestra solo logueado) -->
    <div id="userMenuContainer" style="display:none;">
      <div id="userMenuButton">
        <span id="userNameText"></span> ‚ñº
      </div>
      <div id="userMenuDropdown">
        <button id="menuPerfil">Perfil</button>
        <button id="menuHistorial">Historial de misiones</button>
        <button id="menuLogout">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="login" class="active">
    <h2>Login</h2>
    <input type="text" id="loginUser" placeholder="Correo electr√≥nico">
    <input type="password" id="loginPass" placeholder="Contrase√±a">
    <button id="btnLogin">Ingresar</button>
    <p>¬øNo tienes cuenta? <a href="#" id="showRegister">Reg√≠strate</a></p>
  </section>

  <!-- REGISTRO -->
  <section id="register" style="display:none;">
    <h2>Registro</h2>
    <input type="text" id="regUser" placeholder="Usuario">
    <input type="email" id="regEmail" placeholder="Correo electr√≥nico">
    <input type="password" id="regPass" placeholder="Contrase√±a">
    <button id="btnRegister">Registrar</button>
    <p>¬øYa tienes cuenta? <a href="#" id="showLogin">Volver al login</a></p>
  </section>

  <!-- APLICACI√ìN -->
  <main id="app" style="display:none;">
    <div id="usuarioLogueado"></div>

    <nav>
      <button id="btn-crear" class="active">‚ûï Crear Misi√≥n</button>
      <button id="btn-ver">üìú Ver Misiones</button>
      <button id="btn-completadas">‚úÖ Completadas</button>
    </nav>

    <!-- CREAR MISI√ìN -->
    <div class="section-wrapper">
      <section id="crear" class="active tab-section">
        <form id="formMision">
          <input type="text" id="titulo" placeholder="T√≠tulo autom√°tico" readonly>

          <label>Recurso necesario:</label>
          <div style="display:flex; gap:10px;">
            <!-- CANTIDAD EN STACKS -->
            <select id="stacks" style="flex:1;">
              <option value="">Stacks</option>
            </select>

            <!-- RECURSO -->
            <select id="recurso" style="flex:2;">
              <option value="">Selecciona un recurso</option>
            </select>
          </div>

          <input type="number" id="oro" placeholder="Recompensa en oro" required>
          <input type="text" id="autor" placeholder="Tu nombre" readonly>

          <button type="submit" class="submit">üìú Agregar misi√≥n</button>
        </form>
      </section>
    </div>

    <!-- VER MISIONES -->
    <div class="section-wrapper">
      <section id="ver" class="tab-section">
        <h2>Misiones Activas</h2>

        <div class="filtros">
          <select id="filtroRecurso">
            <option value="">Todos los recursos</option>
          </select>
          <button id="ordenarOro">üí∞ Ordenar por recompensa</button>
        </div>

        <div id="listaMisiones"></div>
      </section>
    </div>

    <!-- MISIONES COMPLETADAS -->
    <div class="section-wrapper">
      <section id="completadas" class="tab-section">
        <h2>Misiones Completadas</h2>

        <div class="filtros">
          <select id="filtroCreador">
            <option value="">Todos los creadores</option>
          </select>
          <select id="filtroCompletador">
            <option value="">Todos los completadores</option>
          </select>
        </div>

        <div id="listaCompletadas"></div>
      </section>
    </div>

    <!-- PERFIL (por ahora no se usa, solo placeholder) -->
    <div class="section-wrapper">
      <section id="perfilSec" style="display:none; padding:20px;">
        <h2 style="color:white;">Perfil del Jugador</h2>
        <div class="perfil-card" style="
          background:#2d2d2d;
          color:white;
          padding:20px;
          border-radius:10px;
          margin-bottom:20px;
          max-width:400px;
        ">
          <p><strong>Nombre:</strong> <span id="perfilNombre"></span></p>
          <p><strong>Email:</strong> <span id="perfilEmail"></span></p>
          <p><strong>Rol:</strong> <span id="perfilRol"></span></p>
          <p><strong>Miembro desde:</strong> <span id="perfilFecha"></span></p>

          <h3>Estad√≠sticas</h3>
          <p><strong>Misiones creadas:</strong> <span id="perfilCreadas">0</span></p>
          <p><strong>Misiones completadas:</strong> <span id="perfilCompletadas">0</span></p>
          <p><strong>Total de stacks recolectados:</strong> <span id="perfilStacks">0</span></p>
          <p><strong>Oro generado:</strong> <span id="perfilOro">0</span></p>
        </div>

        <button id="volverApp">Volver al tabl√≥n</button>
      </section>
    </div>
  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    // ==========================
    // CONFIGURACI√ìN SUPABASE
    // ==========================
    const SUPABASE_URL = "https://ipwxzkdpgbwgdeflzaks.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwd3h6a2RwZ2J3Z2RlZmx6YWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTQ4NDksImV4cCI6MjA3ODM5MDg0OX0.LwtXhr_AY-6f09thVqaUSiop2YvqEEc4X5Vg1-jZQvQ";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==========================
    // ESTADO EN MEMORIA
    // ==========================
    let misiones = [];
    let completadas = [];
    let loggedUser = null;
    let recursosMap = {}; // { nombre: unidades_por_stack }
    let ordenarPorOro = false;

    // ==========================
    // REFERENCIAS AL DOM
    // ==========================
    const loginSec = document.getElementById("login");
    const registerSec = document.getElementById("register");
    const appSec = document.getElementById("app");

    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const regUser = document.getElementById("regUser");
    const regEmail = document.getElementById("regEmail");
    const regPass = document.getElementById("regPass");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");
    const showRegister = document.getElementById("showRegister");
    const showLogin = document.getElementById("showLogin");
    const usuarioLogueado = document.getElementById("usuarioLogueado");

    const form = document.getElementById("formMision");
    const titulo = document.getElementById("titulo");
    const stacksSel = document.getElementById("stacks");
    const recursoSel = document.getElementById("recurso");
    const oroInput = document.getElementById("oro");
    const autorInput = document.getElementById("autor");
    const filtroRecurso = document.getElementById("filtroRecurso");
    const ordenarBtn = document.getElementById("ordenarOro");
    const listaMisiones = document.getElementById("listaMisiones");
    const listaCompletadas = document.getElementById("listaCompletadas");
    const filtroCreador = document.getElementById("filtroCreador");
    const filtroCompletador = document.getElementById("filtroCompletador");

    const userMenuContainer = document.getElementById("userMenuContainer");
    const userMenuButton = document.getElementById("userMenuButton");
    const userMenuDropdown = document.getElementById("userMenuDropdown");
    const userNameText = document.getElementById("userNameText");

    const menuPerfil = document.getElementById("menuPerfil");
    const menuHistorial = document.getElementById("menuHistorial");
    const menuLogout = document.getElementById("menuLogout");
    const perfilSec = document.getElementById("perfilSec");
    const volverApp = document.getElementById("volverApp");

    const secciones = {
      crear: document.getElementById("crear"),
      ver: document.getElementById("ver"),
      completadas: document.getElementById("completadas"),
    };

    const botones = {
      crear: document.getElementById("btn-crear"),
      ver: document.getElementById("btn-ver"),
      completadas: document.getElementById("btn-completadas"),
    };

    // ==========================
    // UTILIDADES
    // ==========================
    function actualizarUsuarioLogueadoUI() {
      if (loggedUser) {
        usuarioLogueado.textContent = `Usuario: ${loggedUser}`;
        userNameText.textContent = loggedUser;
        autorInput.value = loggedUser;
      } else {
        usuarioLogueado.textContent = "";
        userNameText.textContent = "";
        autorInput.value = "";
      }
    }

    function inicializarStacks() {
      stacksSel.innerHTML = '<option value="">Stacks</option>';
      for (let i = 1; i <= 36; i++) {
        const o = document.createElement("option");
        o.value = i;
        o.textContent = i;
        stacksSel.appendChild(o);
      }
    }

    async function cargarRecursos() {
      try {
        const { data, error } = await supabaseClient
          .from("recursos")
          .select("*")
          .order("nombre", { ascending: true });

        if (error) {
          console.error("Error cargando recursos:", error);
          return;
        }

        recursosMap = {};
        recursoSel.innerHTML = '<option value="">Selecciona un recurso</option>';
        filtroRecurso.innerHTML = '<option value="">Todos los recursos</option>';

        data.forEach((r) => {

          recursosMap[r.nombre] = {
            unidades: r.unidades_por_stack || 0,
            valor: r.valor_unidad || 0
          };

          const opt1 = document.createElement("option");
          opt1.value = r.nombre;
          opt1.textContent = r.nombre;
          recursoSel.appendChild(opt1);

          const opt2 = document.createElement("option");
          opt2.value = r.nombre;
          opt2.textContent = r.nombre;
          filtroRecurso.appendChild(opt2);
        });
      } catch (e) {
        console.error("Error de conexi√≥n al cargar recursos:", e);
      }
    }

    function actualizarTitulo() {
      const stacks = parseInt(stacksSel.value);
      const recurso = recursoSel.value;

      if (!stacks || !recurso) {
        titulo.value = "";
        oroInput.value = "";
        return;
      }

      const info = recursosMap[recurso];

      if (!info) return;

      const unidadesTotales = stacks * info.unidades;
      const oroCalculado = Math.round(unidadesTotales * info.valor);

      // Actualiza t√≠tulo y oro autom√°ticamente
      titulo.value = `Recolectar ${stacks} stacks de ${recurso}`;
      oroInput.value = oroCalculado;
    }

    stacksSel.addEventListener("change", actualizarTitulo);
    recursoSel.addEventListener("change", actualizarTitulo);

    // ==========================
    // CARGAR MISIONES
    // ==========================
    async function cargarMisiones() {
      try {
        const { data, error } = await supabaseClient
          .from("misiones")
          .select("*")
          .order("created_at", { ascending: true });

        if (error) {
          console.error("Error cargando misiones:", error);
          alert("No se pudieron cargar las misiones.");
          return;
        }

        misiones = data.filter((m) => !m.completada);
        completadas = data.filter((m) => m.completada);

        renderMisiones();
        renderCompletadas();
      } catch (e) {
        console.error("Error de conexi√≥n al cargar misiones:", e);
        alert("Error de conexi√≥n al cargar misiones.");
      }
    }

    // ==========================
    // LOGIN / REGISTRO
    // ==========================
    showRegister.addEventListener("click", (e) => {
      e.preventDefault();
      loginSec.style.display = "none";
      registerSec.style.display = "block";
    });

    showLogin.addEventListener("click", (e) => {
      e.preventDefault();
      registerSec.style.display = "none";
      loginSec.style.display = "block";
    });

    // Registro
    btnRegister.addEventListener("click", async () => {
      const nombre = regUser.value.trim();
      const email = regEmail.value.trim();
      const pass = regPass.value.trim();

      if (!nombre || !email || !pass) {
        alert("Por favor complet√° todos los campos.");
        return;
      }

      try {
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password: pass,
          options: { data: { nombre } },
        });

        if (error) {
          console.error(error);
          alert(error.message || "Error al registrar usuario.");
          return;
        }

        if (data && data.user) {
          const { error: insertError } = await supabaseClient
            .from("usuarios")
            .insert([
              {
                auth_id: data.user.id,
                nombre,
                email,
                rol: "jugador",
              },
            ]);

          if (insertError) {
            console.error("Error insertando usuario en tabla usuarios:", insertError);
            alert("Error guardando datos en la base de usuarios.");
            return;
          }
        }

        alert("Usuario registrado. Ahora pod√©s iniciar sesi√≥n.");
        regUser.value = "";
        regEmail.value = "";
        regPass.value = "";
        registerSec.style.display = "none";
        loginSec.style.display = "block";
      } catch (err) {
        console.error(err);
        alert("Error de conexi√≥n con Supabase.");
      }
    });

    // Login
    btnLogin.addEventListener("click", async () => {
      const email = loginUser.value.trim();
      const pass = loginPass.value.trim();

      if (!email || !pass) {
        alert("Complet√° correo y contrase√±a.");
        return;
      }

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password: pass,
        });

        if (error) {
          console.error(error);
          alert("Usuario o contrase√±a incorrectos.");
          return;
        }

        const user = data.user;
        let nombre = email;

        const { data: perfil, error: perfilError } = await supabaseClient
          .from("usuarios")
          .select("nombre")
          .eq("auth_id", user.id)
          .maybeSingle();

        if (!perfilError && perfil && perfil.nombre) {
          nombre = perfil.nombre;
        }

        loggedUser = nombre;
        actualizarUsuarioLogueadoUI();

        loginSec.style.display = "none";
        registerSec.style.display = "none";
        appSec.style.display = "block";
        userMenuContainer.style.display = "block";

        inicializarStacks();
        await cargarRecursos();
        await cargarMisiones();
      } catch (e) {
        console.error("Error de conexi√≥n en login:", e);
        alert("Error de conexi√≥n al iniciar sesi√≥n.");
      }
    });

    // ==========================
    // CREAR MISI√ìN
    // ==========================
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!titulo.value || !stacksSel.value || !recursoSel.value) {
        alert("Seleccion√° stacks, recurso y complet√° el oro.");
        return;
      }

      if (!loggedUser) {
        alert("Ten√©s que estar logueado para crear misiones.");
        return;
      }

      const nuevaMision = {
        titulo: titulo.value,
        recurso: recursoSel.value,
        stacks: parseInt(stacksSel.value),
        oro: parseInt(oroInput.value) || 0,
        autor: loggedUser,
        tomada_por: null,
        completada: false,
        completada_por: null,
      };

      try {
        const { data, error } = await supabaseClient
          .from("misiones")
          .insert([nuevaMision])
          .select()
          .single();

        if (error) {
          console.error("Error creando misi√≥n:", error);
          alert("No se pudo crear la misi√≥n.");
          return;
        }

        misiones.unshift(data);
        form.reset();
        titulo.value = "";
        inicializarStacks();
        await cargarRecursos();
        renderMisiones();
      } catch (err) {
        console.error("Error de conexi√≥n al crear misi√≥n:", err);
        alert("Error de conexi√≥n al crear misi√≥n.");
      }
    });

    // ==========================
    // ACCIONES SOBRE MISIONES
    // ==========================
    async function tomarMision(id) {
      if (!loggedUser) {
        alert("Ten√©s que estar logueado para tomar misiones.");
        return;
      }

      const idx = misiones.findIndex((m) => m.id === id);
      if (idx === -1) return;

      try {
        const { error } = await supabaseClient
          .from("misiones")
          .update({ tomada_por: loggedUser })
          .eq("id", id);

        if (error) {
          console.error("Error tomando misi√≥n:", error);
          alert("No se pudo tomar la misi√≥n.");
          return;
        }

        misiones[idx].tomada_por = loggedUser;
        renderMisiones();
      } catch (e) {
        console.error("Error de conexi√≥n al tomar misi√≥n:", e);
        alert("Error de conexi√≥n al tomar misi√≥n.");
      }
    }

    async function completarMisionPorId(id) {
      if (!loggedUser) {
        alert("Ten√©s que estar logueado para completar misiones.");
        return;
      }

      const idx = misiones.findIndex((m) => m.id === id);
      if (idx === -1) return;

      const m = misiones[idx];

      // Solo puede completar el creador o quien la tom√≥
      if (loggedUser !== m.autor && loggedUser !== m.tomada_por) {
        alert("Solo el creador o quien tom√≥ la misi√≥n puede completarla.");
        return;
      }

      const completador = m.tomada_por || loggedUser;

      try {
        const { error } = await supabaseClient
          .from("misiones")
          .update({ completada: true, completada_por: completador })
          .eq("id", id);

        if (error) {
          console.error("Error completando misi√≥n:", error);
          alert("No se pudo completar la misi√≥n.");
          return;
        }

        m.completada = true;
        m.completada_por = completador;
        misiones.splice(idx, 1);
        completadas.unshift(m);
        renderMisiones();
        renderCompletadas();
      } catch (e) {
        console.error("Error de conexi√≥n al completar misi√≥n:", e);
        alert("Error de conexi√≥n al completar misi√≥n.");
      }
    }

    async function borrarMision(id) {
      if (!confirm("¬øBorrar esta misi√≥n?")) return;

      try {
        const { error } = await supabaseClient
          .from("misiones")
          .delete()
          .eq("id", id);

        if (error) {
          console.error("Error borrando misi√≥n:", error);
          alert("No se pudo borrar la misi√≥n.");
          return;
        }

        misiones = misiones.filter((x) => x.id !== id);
        completadas = completadas.filter((x) => x.id !== id);
        renderMisiones();
        renderCompletadas();
      } catch (e) {
        console.error("Error de conexi√≥n al borrar misi√≥n:", e);
        alert("Error de conexi√≥n al borrar misi√≥n.");
      }
    }

    // ==========================
    // RENDER MISIONES
    // ==========================
    function renderMisiones() {
      listaMisiones.innerHTML = "";

      let visibles = [...misiones];

      if (filtroRecurso.value) {
        visibles = visibles.filter((m) => m.recurso === filtroRecurso.value);
      }

      if (ordenarPorOro) {
        visibles.sort((a, b) => (b.oro || 0) - (a.oro || 0));
      }

      if (visibles.length === 0) {
        listaMisiones.innerHTML =
          "<p>No hay misiones activas con esos criterios.</p>";
        return;
      }

      visibles.forEach((m) => {
        const unidadesStack = recursosMap[m.recurso] || 0;
        const totalUnidades = unidadesStack * (m.stacks || 0);

        const card = document.createElement("div");
        card.className = "mision" + (m.tomada_por ? " tomada" : "");
        card.innerHTML = `
          <h3>${m.titulo}</h3>
          <p>üè∑Ô∏è Recurso: ${m.recurso} (${m.stacks} stacks = ${totalUnidades} unidades)</p>
          <p>üí∞ Recompensa: ${m.oro} oro</p>
          <p>üìÖ Creada el: ${
            m.created_at ? new Date(m.created_at).toLocaleDateString() : "-"
          }</p>
          <p>üë§ Autor: ${m.autor}</p>
          ${
            m.tomada_por
              ? `<p>‚öíÔ∏è En curso por: <strong>${m.tomada_por}</strong></p>`
              : ""
          }
        `;

        const btns = document.createElement("div");
        btns.className = "botones-mision";

        if (!m.tomada_por && loggedUser) {
          const takeBtn = document.createElement("button");
          takeBtn.textContent = "ü™ì Tomar";
          takeBtn.addEventListener("click", () => tomarMision(m.id));
          btns.appendChild(takeBtn);
        }

        // Bot√≥n completar solo para creador o quien la tom√≥
        if (
          loggedUser &&
          !m.completada &&
          (loggedUser === m.autor || loggedUser === m.tomada_por)
        ) {
          const compBtn = document.createElement("button");
          compBtn.textContent = "‚úÖ Completar";
          compBtn.addEventListener("click", () => completarMisionPorId(m.id));
          btns.appendChild(compBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è Borrar";
        delBtn.addEventListener("click", () => borrarMision(m.id));
        btns.appendChild(delBtn);

        card.appendChild(btns);
        listaMisiones.appendChild(card);
      });
    }

    function renderCompletadas() {
      listaCompletadas.innerHTML = "";

      // Filtros desplegables
      const creadores = [...new Set(completadas.map((m) => m.autor))].filter(
        Boolean
      );
      filtroCreador.innerHTML =
        '<option value="">Todos los creadores</option>';
      creadores.forEach((c) => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        filtroCreador.appendChild(o);
      });

      const completadores = [
        ...new Set(completadas.map((m) => m.completada_por)),
      ].filter(Boolean);
      filtroCompletador.innerHTML =
        '<option value="">Todos los completadores</option>';
      completadores.forEach((c) => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        filtroCompletador.appendChild(o);
      });

      let visibles = [...completadas];

      if (filtroCreador.value) {
        visibles = visibles.filter((m) => m.autor === filtroCreador.value);
      }
      if (filtroCompletador.value) {
        visibles = visibles.filter(
          (m) => m.completada_por === filtroCompletador.value
        );
      }

      if (visibles.length === 0) {
        listaCompletadas.innerHTML =
          "<p>No hay misiones completadas con esos criterios.</p>";
        return;
      }

      visibles.forEach((m) => {
        const card = document.createElement("div");
        card.className = "mision tomada";
        card.innerHTML = `
          <h3>${m.titulo}</h3>
          <p>üè∑Ô∏è ${m.recurso} (${m.stacks} stacks)</p>
          <p>üí∞ ${m.oro} oro</p>
          <p>üë§ Creada por: ${m.autor}</p>
          <p>‚úÖ Completada por: <strong>${
            m.completada_por || "-"
          }</strong></p>
        `;
        listaCompletadas.appendChild(card);
      });
    }

    // ==========================
    // FILTROS Y ORDEN
    // ==========================
    filtroRecurso.addEventListener("change", renderMisiones);
    filtroCreador.addEventListener("change", renderCompletadas);
    filtroCompletador.addEventListener("change", renderCompletadas);

    ordenarBtn.addEventListener("click", () => {
      ordenarPorOro = !ordenarPorOro;
      ordenarBtn.textContent = ordenarPorOro
        ? "üîΩ Mostrar todas"
        : "üí∞ Ordenar por recompensa";
      renderMisiones();
    });

    // ==========================
    // NAVEGACI√ìN ENTRE SECCIONES
    // ==========================
    Object.keys(botones).forEach((k) => {
      botones[k].addEventListener("click", () => {
        Object.values(secciones).forEach((s) => s.classList.remove("active"));
        Object.values(botones).forEach((b) => b.classList.remove("active"));
        secciones[k].classList.add("active");
        botones[k].classList.add("active");

        if (k === "ver") renderMisiones();
        if (k === "completadas") renderCompletadas();
      });
    });

    // ==========================
    // MEN√ö USUARIO
    // ==========================
    userMenuButton.addEventListener("click", () => {
      userMenuDropdown.style.display =
        userMenuDropdown.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", (e) => {
      if (!userMenuContainer.contains(e.target)) {
        userMenuDropdown.style.display = "none";
      }
    });

    menuPerfil.addEventListener("click", () => {
      alert(
        "Estamos trabajando en la construcci√≥n del perfil del jugador. ¬°Pronto estar√° disponible! üõ†Ô∏è"
      );
    });

    menuHistorial.addEventListener("click", () => {
      alert("El historial de misiones a√∫n no est√° disponible. üìú");
    });

    async function cerrarSesion() {
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.error(e);
      }

      loggedUser = null;
      misiones = [];
      completadas = [];
      actualizarUsuarioLogueadoUI();

      appSec.style.display = "none";
      loginSec.style.display = "block";
      registerSec.style.display = "none";
      userMenuContainer.style.display = "none";
    }

    menuLogout.addEventListener("click", cerrarSesion);

    // ==========================
    // INICIO AUTOM√ÅTICO
    // ==========================
    (async function init() {
      // Ocultar men√∫ por defecto
      userMenuContainer.style.display = "none";

      try {
        const { data } = await supabaseClient.auth.getSession();

        if (data && data.session && data.session.user) {
          const user = data.session.user;
          let nombre = user.email;

          const { data: perfil, error: perfilError } = await supabaseClient
            .from("usuarios")
            .select("nombre")
            .eq("auth_id", user.id)
            .maybeSingle();

          if (!perfilError && perfil && perfil.nombre) {
            nombre = perfil.nombre;
          }

          loggedUser = nombre;
          actualizarUsuarioLogueadoUI();

          loginSec.style.display = "none";
          registerSec.style.display = "none";
          appSec.style.display = "block";
          userMenuContainer.style.display = "block";

          inicializarStacks();
          await cargarRecursos();
          await cargarMisiones();
        } else {
          loginSec.style.display = "block";
          registerSec.style.display = "none";
          appSec.style.display = "none";
        }
      } catch (e) {
        console.error("Error en init:", e);
        loginSec.style.display = "block";
        registerSec.style.display = "none";
        appSec.style.display = "none";
      }
    })();
  </script>
</body>
</html>
