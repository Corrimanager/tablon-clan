<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ü™µ Tabl√≥n del Clan - Pax Dei</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap');

    body { font-family: 'Cinzel', serif; background: #3a2f23 url('https://www.transparenttextures.com/patterns/wood-pattern.png'); margin: 0; color: #fdf5e6; font-size: 17px; }
    header { background: linear-gradient(#4b3a28, #2c1f12); text-align: center; padding: 25px; border-bottom: 5px solid #2c1f12; box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.6); }
    header h1 { font-size: 2.3em; color: #e0c28b; text-shadow: 3px 3px #000; }
    main { display: flex; flex-direction: column; align-items: center; padding: 20px; }
    nav { margin-bottom: 20px; }
    nav button { background: #6b4b2e; color: #fdf5e6; border: 2px solid #2c1f12; padding: 10px 20px; margin: 0 5px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; box-shadow: 0 3px 5px rgba(0,0,0,0.5); font-size: 16px; }
    nav button:hover { background: #8b643a; transform: scale(1.05); }
    nav button.active { background: #c49a5f; color: #2c1f12; border: 2px solid #f0e2b6; }
    section { display: none; width: 100%; max-width: 900px; background: #f8ecd2 url('https://www.transparenttextures.com/patterns/aged-paper.png'); color: #2c1f12; padding: 25px; border-radius: 15px; border: 4px solid #2c1f12; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); animation: fadeIn 0.5s ease-in-out; }
    section.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform:scale(0.98);} to { opacity:1; transform:scale(1);} }
    label { font-weight: bold; color: #2c1f12; }
    input, select { width: 100%; padding: 8px; margin-bottom: 10px; font-family: 'Cinzel', serif; background: #f5e3b3; border: 2px solid #2c1f12; border-radius: 5px; color: #2c1f12; font-size: 17px; }
    button.submit { background: #c49a5f; color: #2c1f12; border: 2px solid #f0e2b6; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px; }
    button.submit:hover { background: #d8b36e; transform: scale(1.05); }
    .mision { background: #f5e3b3; border: 3px solid #2c1f12; border-radius: 10px; padding: 15px; margin-bottom: 15px; color: #2c1f12; box-shadow: 0 0 10px rgba(0,0,0,0.4); transition: 0.3s; font-size: 17px; }
    .mision:hover { transform: translateY(-3px); box-shadow: 0 0 15px rgba(0,0,0,0.6); }
    .mision.tomada { background: #d6c08a; }
    .mision h3, .mision h4 { margin-top: 0; color: #3b2a1a; font-size: 1.4em; }
    .recompensa { color: #a67c00; font-weight: bold; }
    .botones-mision button { background: #6b4b2e; color: #fdf5e6; border: 2px solid #2c1f12; padding: 6px 10px; border-radius: 5px; cursor: pointer; margin-right: 6px; transition: 0.2s; font-size: 15px; }
    .botones-mision button:hover { background: #8b643a; }
    h2 { font-size: 1.7em; text-align: center; color: #2c1f12; border-bottom: 2px solid #c49a5f; padding-bottom:5px; letter-spacing:1px; }
    .filtros { display:flex; justify-content:center; gap:15px; margin-bottom:15px; align-items:center; }
    .filtros select, .filtros button { font-size: 16px; padding: 7px 12px; }
    #btnPerfil { display:none; } /* Oculto al inicio */
  </style>
</head>
<body>
  <header><h1>ü™µ Tabl√≥n del Clan - Pax Dei</h1></header>

  <main>
    <nav>
      <button id="btn-crear" class="active">‚ûï Crear Misi√≥n</button>
      <button id="btn-ver">üìú Ver Misiones</button>
      <button id="btn-completadas">‚úÖ Completadas</button>
      <button id="btnPerfil">üë§ Mi Perfil</button>
    </nav>

    <!-- LOGIN -->
    <section id="login" class="active">
      <h2>Login</h2>
      <input type="text" id="loginUser" placeholder="Usuario">
      <input type="password" id="loginPass" placeholder="Contrase√±a">
      <button id="btnLogin" class="submit">Ingresar</button>
      <p>No tienes cuenta? <button id="btnRegistroForm">Registrarse</button></p>
    </section>

    <!-- REGISTRO -->
    <section id="registro">
      <h2>Registro</h2>
      <input type="text" id="registroUser" placeholder="Usuario">
      <input type="password" id="registroPass" placeholder="Contrase√±a">
      <button id="btnRegistro" class="submit">Registrarse</button>
      <p>Ya tienes cuenta? <button id="btnLoginForm">Ingresar</button></p>
    </section>

    <!-- CREAR -->
    <section id="crear">
      <form id="formMision">
        <input type="text" id="titulo" placeholder="T√≠tulo autom√°tico" readonly>
        <label>Recurso necesario:</label>
        <div style="display:flex; gap:10px;">
          <select id="stacks" style="flex:1;"><option value="">Stacks</option></select>
          <select id="recurso" style="flex:2;"><option value="">Selecciona un recurso</option></select>
        </div>
        <input type="number" id="oro" placeholder="Recompensa en oro" required>
        <input type="text" id="autor" placeholder="Tu nombre" readonly>
        <button type="submit" class="submit">üìú Agregar misi√≥n</button>
      </form>
    </section>

    <!-- VER -->
    <section id="ver">
      <h2>Misiones Activas</h2>
      <div class="filtros">
        <select id="filtroRecurso"><option value="">Todos los recursos</option></select>
        <button id="ordenarOro">üí∞ Ordenar por recompensa</button>
      </div>
      <div id="listaMisiones"></div>
    </section>

    <!-- COMPLETADAS -->
    <section id="completadas">
      <h2>Misiones Completadas</h2>
      <div class="filtros">
        <select id="filtroCreador"><option value="">Todos los creadores</option></select>
        <select id="filtroTomado"><option value="">Todos los que completaron</option></select>
      </div>
      <div id="listaCompletadas"></div>
    </section>

    <!-- PERFIL -->
    <section id="perfil">
      <h2>Mi Perfil</h2>
      <div id="estadisticas"></div>
      <h3>Misiones completadas</h3>
      <div id="historialCompletadas"></div>
      <h3>Misiones creadas</h3>
      <div id="historialCreadas"></div>
    </section>
  </main>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  // ---------------- CONFIG ----------------
  const SUPABASE_URL = 'TU_API_URL';
  const SUPABASE_KEY = 'TU_API_KEY';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const recursos = { Albura:50, Arcilla:100, Juncos:75, Piedra:100 };

  const form = document.getElementById('formMision');
  const titulo = document.getElementById('titulo');
  const stacksSel = document.getElementById('stacks');
  const recursoSel = document.getElementById('recurso');
  const oroInput = document.getElementById('oro');
  const autorInput = document.getElementById('autor');
  const filtroRecurso = document.getElementById('filtroRecurso');
  const ordenarBtn = document.getElementById('ordenarOro');
  const listaMisiones = document.getElementById('listaMisiones');
  const listaCompletadas = document.getElementById('listaCompletadas');

  const secciones = {
    login: document.getElementById('login'),
    registro: document.getElementById('registro'),
    crear: document.getElementById('crear'),
    ver: document.getElementById('ver'),
    completadas: document.getElementById('completadas'),
    perfil: document.getElementById('perfil')
  };

  const botones = {
    crear: document.getElementById('btn-crear'),
    ver: document.getElementById('btn-ver'),
    completadas: document.getElementById('btn-completadas'),
    perfil: document.getElementById('btnPerfil')
  };

  let misiones = [];
  let completadas = [];
  let loggedUser = localStorage.getItem('loggedUser') || null;
  let ordenarPorOro = false;

  // ---------------- NAV ----------------
  Object.keys(botones).forEach(k => {
    botones[k].addEventListener('click', () => {
      Object.values(secciones).forEach(s => s.classList.remove('active'));
      Object.values(botones).forEach(b => b.classList.remove('active'));
      secciones[k].classList.add('active'); 
      botones[k].classList.add('active');
      if(k==='ver') renderMisiones();
      if(k==='completadas') renderCompletadas();
      if(k==='perfil') mostrarPerfil();
    });
  });

  function actualizarBotonPerfil(){
    botones.perfil.style.display = loggedUser ? 'inline-block' : 'none';
  }
  actualizarBotonPerfil();
  if(loggedUser) autorInput.value = loggedUser;

  // ---------------- REGISTRO / LOGIN ----------------
  document.getElementById('btnRegistroForm').addEventListener('click',()=>{
    secciones.login.classList.remove('active');
    secciones.registro.classList.add('active');
  });
  document.getElementById('btnLoginForm').addEventListener('click',()=>{
    secciones.registro.classList.remove('active');
    secciones.login.classList.add('active');
  });

  async function registrarUsuario(usuario, pass){
    const { data, error } = await supabase.from('usuarios').insert([{usuario,pass}]);
    if(error) return alert('Error: '+error.message);
    alert('Usuario registrado! Ahora pod√©s loguearte.');
    secciones.registro.classList.remove('active');
    secciones.login.classList.add('active');
  }
  document.getElementById('btnRegistro').addEventListener('click', async ()=>{
    const usuario=document.getElementById('registroUser').value.trim();
    const pass=document.getElementById('registroPass').value;
    if(!usuario || !pass) return alert('Completa todos los campos');
    await registrarUsuario(usuario,pass);
  });

  async function loginUsuario(usuario, pass){
    const { data, error } = await supabase.from('usuarios').select('*').eq('usuario',usuario).eq('pass',pass).single();
    if(error) return alert('Usuario o contrase√±a incorrectos');
    loggedUser = usuario;
    localStorage.setItem('loggedUser',loggedUser);
    autorInput.value = loggedUser;
    alert('Bienvenido '+loggedUser);
    secciones.login.classList.remove('active'); secciones.crear.classList.add('active');
    actualizarBotonPerfil();
  }
  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const usuario=document.getElementById('loginUser').value.trim();
    const pass=document.getElementById('loginPass').value;
    if(!usuario || !pass) return alert('Completa todos los campos');
    await loginUsuario(usuario,pass);
  });

  // ---------------- POPULATE ----------------
  for(let i=1;i<=36;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; stacksSel.appendChild(o);}
  Object.keys(recursos).forEach(r=>{
    const o=document.createElement('option'); o.value=r; o.textContent=r; recursoSel.appendChild(o);
    const of=o.cloneNode(true); filtroRecurso.appendChild(of);
  });
  stacksSel.addEventListener('change', actualizarTitulo);
  recursoSel.addEventListener('change', actualizarTitulo);

  function actualizarTitulo(){
    if(stacksSel.value && recursoSel.value) titulo.value = `Recolectar ${stacksSel.value} stacks de ${recursoSel.value}`;
    else titulo.value='';
  }

  // ---------------- CREAR MISION ----------------
  form.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!titulo.value) return alert('Selecciona un stack y un recurso.');
    await supabase.from('misiones').insert([{
      titulo:titulo.value,
      stack:parseInt(stacksSel.value),
      recurso:recursoSel.value,
      oro:parseInt(oroInput.value)||0,
      autor:loggedUser,
      tomadoPor:null,
      completada:false,
      fecha:new Date()
    }]);
    form.reset(); titulo.value=''; await renderMisiones();
  });

  // ---------------- RENDER ----------------
  async function renderMisiones(){
    const { data,error } = await supabase.from('misiones').select('*').eq('completada',false);
    if(error) return alert(error.message);
    misiones=data;

    let visible = [...misiones];
    const filtro=filtroRecurso.value;
    if(filtro) visible = visible.filter(m=>m.recurso===filtro);
    if(ordenarPorOro) visible.sort((a,b)=>b.oro-a.oro);

    listaMisiones.innerHTML='';
    if(visible.length===0){ listaMisiones.innerHTML='<p>No hay misiones activas.</p>'; return; }

    visible.forEach(m=>{
      const total=(recursos[m.recurso]||0)*m.stack;
      const card=document.createElement('div'); card.className='mision'+(m.tomadoPor?' tomada':'');
      card.innerHTML=`
        <h3>${m.titulo}</h3>
        <p>üè∑Ô∏è Recurso: ${m.recurso} (${m.stack} stacks = ${total} unidades)</p>
        <p>üìÖ Creada el: ${new Date(m.fecha).toLocaleDateString()}</p>
        <p>üë§ Autor: ${m.autor}</p>
        <p class="recompensa">üí∞ Recompensa: ${m.oro} oro</p>
        ${m.tomadoPor?`<p>‚öíÔ∏è En curso por: <strong>${m.tomadoPor}</strong></p>`:''}
      `;
      const btns=document.createElement('div'); btns.className='botones-mision';
      if(!m.tomadoPor){
        const takeBtn=document.createElement('button'); takeBtn.textContent='ü™ì Tomar';
        takeBtn.addEventListener('click', async ()=>{ await supabase.from('misiones').update({tomadoPor:loggedUser}).eq('id',m.id); renderMisiones(); });
        btns.appendChild(takeBtn);
      } else {
        const compBtn=document.createElement('button'); compBtn.textContent='‚úÖ Completar';
        compBtn.addEventListener('click', async ()=>{
          await supabase.from('misiones').update({completada:true}).eq('id',m.id);
          renderMisiones(); renderCompletadas();
        });
        btns.appendChild(compBtn);
      }
      const delBtn=document.createElement('button'); delBtn.textContent='üóëÔ∏è Borrar';
      delBtn.addEventListener('click', async ()=>{
        if(confirm('¬øBorrar esta misi√≥n?')){ await supabase.from('misiones').delete().eq('id',m.id); renderMisiones(); }
      });
      btns.appendChild(delBtn);
      card.appendChild(btns);
      listaMisiones.appendChild(card);
    });
  }

  // ---------------- COMPLETADAS ----------------
  async function renderCompletadas(){
    const { data,error } = await supabase.from('misiones').select('*').eq('completada',true);
    if(error) return alert(error.message);
    completadas=data;

    let vis=completadas;
    const filtroC=filtroCreador.value;
    const filtroT=filtroTomado.value;
    if(filtroC) vis=vis.filter(m=>m.autor===filtroC);
    if(filtroT) vis=vis.filter(m=>m.tomadoPor===filtroT);

    listaCompletadas.innerHTML='';
    if(vis.length===0){ listaCompletadas.innerHTML='<p>No hay misiones completadas.</p>'; return; }
    vis.forEach(m=>{
      const total=(recursos[m.recurso]||0)*m.stack;
      const card=document.createElement('div'); card.className='mision';
      card.innerHTML=`
        <h3>${m.titulo}</h3>
        <p>üè∑Ô∏è Recurso: ${m.recurso} (${m.stack} stacks = ${total} unidades)</p>
        <p>üìÖ Creada el: ${new Date(m.fecha).toLocaleDateString()}</p>
        <p>üë§ Autor: ${m.autor}</p>
        <p>‚öíÔ∏è Completada por: <strong>${m.tomadoPor}</strong></p>
        <p class="recompensa">üí∞ Recompensa: ${m.oro} oro</p>
      `;
      listaCompletadas.appendChild(card);
    });

    // Actualizar filtros de creadores y tomadores
    const creadores=[...new Set(completadas.map(m=>m.autor))];
    filtroCreador.innerHTML='<option value="">Todos los creadores</option>';
    creadores.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; filtroCreador.appendChild(o); });

    const tomadores=[...new Set(completadas.map(m=>m.tomadoPor).filter(Boolean))];
    filtroTomado.innerHTML='<option value="">Todos los que completaron</option>';
    tomadores.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; filtroTomado.appendChild(o); });
  }

  // ---------------- ORDENAR ----------------
  ordenarBtn.addEventListener('click',()=>{ ordenarPorOro=!ordenarPorOro; renderMisiones(); });

  // ---------------- PERFIL ----------------
  async function mostrarPerfil(){
    const { data:error } = await supabase.from('misiones').select('*'); // force sync
    const creadas = misiones.filter(m=>m.autor===loggedUser);
    const completadasU = completadas.filter(m=>m.tomadoPor===loggedUser);
    const totalOro = completadasU.reduce((a,b)=>a+b.oro,0);

    document.getElementById('estadisticas').innerHTML=`
      <p>Usuario: <strong>${loggedUser}</strong></p>
      <p>Misiones completadas: ${completadasU.length}</p>
      <p>Misiones creadas: ${creadas.length}</p>
      <p>Total oro aportado/completado: ${totalOro}</p>
    `;

    const historialC=document.getElementById('historialCreadas');
    historialC.innerHTML=creadas.map(m=>`<div class="mision">${m.titulo} üí∞ ${m.oro}</div>`).join('');
    const historialCom=document.getElementById('historialCompletadas');
    historialCom.innerHTML=completadasU.map(m=>`<div class="mision">${m.titulo} üí∞ ${m.oro}</div>`).join('');
  }

  // ---------------- INICIAL ----------------
  renderMisiones(); renderCompletadas();
  </script>
</body>
</html>

