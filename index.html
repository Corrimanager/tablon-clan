<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ü™µ Tabl√≥n del Clan - Pax Dei</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500&display=swap');
@import url('https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap');

body { font-family: 'Cinzel', serif; background: #3a2f23 url('https://www.transparenttextures.com/patterns/wood-pattern.png'); margin:0; color:#fdf5e6; font-size:17px; }
header { background: linear-gradient(#4b3a28, #2c1f12); text-align:center; padding:25px; border-bottom:5px solid #2c1f12; box-shadow: inset 0 0 30px rgba(0,0,0,0.6); }
header h1 { font-size:2.3em; color:#e0c28b; text-shadow:3px 3px #000; }
main { display:flex; flex-direction:column; align-items:center; padding:20px; }
nav { margin-bottom:20px; }
nav button { background:#6b4b2e; color:#fdf5e6; border:2px solid #2c1f12; padding:10px 20px; margin:0 5px; cursor:pointer; border-radius:8px; font-weight:bold; transition:0.3s; box-shadow:0 3px 5px rgba(0,0,0,0.5); font-size:16px; }
nav button:hover { background:#8b643a; transform: scale(1.05); }
nav button.active { background:#c49a5f; color:#2c1f12; border:2px solid #f0e2b6; }
section { display:none; width:100%; max-width:900px; background:#f8ecd2 url('https://www.transparenttextures.com/patterns/aged-paper.png'); color:#2c1f12; padding:25px; border-radius:15px; border:4px solid #2c1f12; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); animation:fadeIn 0.5s ease-in-out; }
section.active { display:block; }
@keyframes fadeIn { from{opacity:0; transform:scale(0.98);} to{opacity:1; transform:scale(1);} }
label { font-weight:bold; color:#2c1f12; }
input, select { width:100%; padding:8px; margin-bottom:10px; font-family:'Cinzel', serif; background:#f5e3b3; border:2px solid #2c1f12; border-radius:5px; color:#2c1f12; font-size:17px; }
button.submit { background:#c49a5f; color:#2c1f12; border:2px solid #f0e2b6; padding:10px 15px; border-radius:8px; font-weight:bold; cursor:pointer; transition:0.3s; font-size:16px; }
button.submit:hover { background:#d8b36e; transform:scale(1.05); }
.mision { background:#f5e3b3; border:3px solid #2c1f12; border-radius:10px; padding:15px; margin-bottom:15px; color:#2c1f12; box-shadow:0 0 10px rgba(0,0,0,0.4); transition:0.3s; font-size:17px; }
.mision:hover { transform:translateY(-3px); box-shadow:0 0 15px rgba(0,0,0,0.6); }
.mision.tomada { background:#d6c08a; }
.mision h3 { margin-top:0; color:#3b2a1a; font-size:1.4em; }
.recompensa { color:#a67c00; font-weight:bold; }
.botones-mision button { background:#6b4b2e; color:#fdf5e6; border:2px solid #2c1f12; padding:6px 10px; border-radius:5px; cursor:pointer; margin-right:6px; transition:0.2s; font-size:15px; }
.botones-mision button:hover { background:#8b643a; }
h2 { font-size:1.7em; text-align:center; color:#2c1f12; border-bottom:2px solid #c49a5f; padding-bottom:5px; letter-spacing:1px; }
.filtros { display:flex; justify-content:center; gap:15px; margin-bottom:15px; align-items:center; }
.filtros select, .filtros button { font-size:16px; padding:7px 12px; }
#usuarioLogueado { margin-bottom: 15px; font-weight:bold; }
/* Contenedor del men√∫ */
#userMenuContainer {
  position: absolute;
  top: 20px;
  left: 20px;
  color: #e0c28b;
  font-family: 'Cinzel', serif;
  font-size: 18px;
  cursor: pointer;
  user-select: none;
}

/* Bot√≥n principal */
#userMenuButton {
  background: rgba(0,0,0,0.4);
  padding: 8px 15px;
  border: 2px solid #c49a5f;
  border-radius: 8px;
  box-shadow: 0 0 8px rgba(0,0,0,0.5);
  transition: 0.3s;
}

#userMenuButton:hover {
  background: rgba(0,0,0,0.6);
}

/* Dropdown */
#userMenuDropdown {
  display: none;
  position: absolute;
  top: 45px;
  left: 0;
  background: #3a2f23;
  border: 2px solid #c49a5f;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.6);
  padding: 10px;
  z-index: 10;
}

#userMenuDropdown button {
  display: block;
  width: 100%;
  text-align: left;
  background: none;
  border: none;
  color: #e0c28b;
  padding: 10px;
  font-family: 'Cinzel', serif;
  font-size: 16px;
  cursor: pointer;
  transition: 0.2s;
}

#userMenuDropdown button:hover {
  background: rgba(255,255,255,0.1);
}

</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header><h1>ü™µ Tabl√≥n del Clan - Pax Dei</h1>
<div id="userMenuContainer">
  <div id="userMenuButton">
    <span id="userNameText"></span> ‚ñº
  </div>
  <div id="userMenuDropdown">
    <button id="menuPerfil">Perfil</button>
    <button id="menuHistorial">Historial de misiones</button>
    <button id="menuLogout">Cerrar sesi√≥n</button>
  </div>
</div>
</header>

<!-- LOGIN -->
<section id="login" class="active">
<h2>Login</h2>
<input type="text" id="loginUser" placeholder="Usuario">
<input type="password" id="loginPass" placeholder="Contrase√±a">
<button id="btnLogin">Ingresar</button>
<p>No tienes cuenta? <a href="#" id="showRegister">Reg√≠strate</a></p>
</section>

<!-- REGISTER -->
<section id="register" style="display:none;">
  <h2>Registro</h2>
  <input type="text" id="regUser" placeholder="Usuario">
  <input type="password" id="regPass" placeholder="Contrase√±a">
  <input type="email" id="regEmail" placeholder="Correo electr√≥nico">
  <button id="btnRegister">Registrar</button>
  <p>Ya tienes cuenta? <a href="#" id="showLogin">Volver al login</a></p>
</section>

<!-- APP -->
<main id="app" style="display:none;">
<div id="usuarioLogueado"></div>
<nav>
<button id="btn-crear" class="active">‚ûï Crear Misi√≥n</button>
<button id="btn-ver">üìú Ver Misiones</button>
<button id="btn-completadas">‚úÖ Completadas</button>
</nav>

<button onclick="cerrarSesion()">Cerrar sesi√≥n</button>

<!-- CREAR -->
<section id="crear" class="active">
<form id="formMision">
<input type="text" id="titulo" placeholder="T√≠tulo autom√°tico" readonly>
<label>Recurso necesario:</label>
<div style="display:flex; gap:10px;">
<select id="stacks" style="flex:1;"><option value="">Stacks</option></select>
<select id="recurso" style="flex:2;"><option value="">Selecciona un recurso</option></select>
</div>
<input type="number" id="oro" placeholder="Recompensa en oro" required>
<input type="text" id="autor" placeholder="Tu nombre" readonly>
<button type="submit" class="submit">üìú Agregar misi√≥n</button>
</form>
</section>

<!-- VER -->
<section id="ver">
<h2>Misiones Activas</h2>
<div class="filtros">
<select id="filtroRecurso"><option value="">Todos los recursos</option></select>
<button id="ordenarOro">üí∞ Ordenar por recompensa</button>
</div>
<div id="listaMisiones"></div>
</section>

<!-- COMPLETADAS -->
<section id="completadas">
<h2>Misiones Completadas</h2>
<div class="filtros">
<select id="filtroCreador"></select>
<select id="filtroCompletador"></select>
</div>
<div id="listaCompletadas"></div>
</section>

<script>
  // ==========================
  // CONFIGURACI√ìN SUPABASE
  // ==========================
  const SUPABASE_URL = "https://ipwxzkdpgbwgdeflzaks.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwd3h6a2RwZ2J3Z2RlZmx6YWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTQ4NDksImV4cCI6MjA3ODM5MDg0OX0.LwtXhr_AY-6f09thVqaUSiop2YvqEEc4X5Vg1-jZQvQ";

  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ==========================
  // DATOS EN LOCALSTORAGE
  // ==========================
  const recursos = { Albura: 50, Arcilla: 100, Juncos: 75, Piedra: 100 };

  let misiones = JSON.parse(localStorage.getItem("misiones")) || [];
  let completadas = JSON.parse(localStorage.getItem("completadas")) || [];
  let loggedUser = localStorage.getItem("loggedUser") || null;

  // ==========================
  // REFERENCIAS AL DOM
  // ==========================
  const loginSec = document.getElementById("login");
  const registerSec = document.getElementById("register");
  const appSec = document.getElementById("app");

  const loginUser = document.getElementById("loginUser");
  const loginPass = document.getElementById("loginPass");
  const regUser = document.getElementById("regUser");
  const regPass = document.getElementById("regPass");
  const regEmail = document.getElementById("regEmail");
  const btnLogin = document.getElementById("btnLogin");
  const btnRegister = document.getElementById("btnRegister");
  const showRegister = document.getElementById("showRegister");
  const showLogin = document.getElementById("showLogin");
  const usuarioLogueado = document.getElementById("usuarioLogueado");

  const form = document.getElementById("formMision");
  const titulo = document.getElementById("titulo");
  const stacksSel = document.getElementById("stacks");
  const recursoSel = document.getElementById("recurso");
  const oroInput = document.getElementById("oro");
  const autorInput = document.getElementById("autor");
  const filtroRecurso = document.getElementById("filtroRecurso");
  const ordenarBtn = document.getElementById("ordenarOro");
  const listaMisiones = document.getElementById("listaMisiones");
  const listaCompletadas = document.getElementById("listaCompletadas");
  const filtroCreador = document.getElementById("filtroCreador");
  const filtroCompletador = document.getElementById("filtroCompletador");

  let ordenarPorOro = false;

  // ==========================
  // UTILIDADES GENERALES
  // ==========================
  function guardar() {
    localStorage.setItem("misiones", JSON.stringify(misiones));
    localStorage.setItem("completadas", JSON.stringify(completadas));
    localStorage.setItem("loggedUser", loggedUser);
  }

  function actualizarUsuarioLogueadoUI() {
    if (loggedUser) {
      usuarioLogueado.textContent = `Usuario: ${loggedUser}`;
    } else {
      usuarioLogueado.textContent = "";
    }
  }

  function inicializarFormMision() {
    // Stacks
    stacksSel.innerHTML = '<option value="">Stacks</option>';
    for (let i = 1; i <= 36; i++) {
      const o = document.createElement("option");
      o.value = i;
      o.textContent = i;
      stacksSel.appendChild(o);
    }

    // Recursos
    recursoSel.innerHTML = '<option value="">Selecciona un recurso</option>';
    Object.keys(recursos).forEach((r) => {
      const o = document.createElement("option");
      o.value = r;
      o.textContent = r;
      recursoSel.appendChild(o);

      // tambi√©n al filtro
      if (!Array.from(filtroRecurso.options).some((opt) => opt.value === r)) {
        filtroRecurso.appendChild(o.cloneNode(true));
      }
    });

    autorInput.value = loggedUser || "";
  }

  function actualizarTitulo() {
    if (stacksSel.value && recursoSel.value) {
      titulo.value = `Recolectar ${stacksSel.value} stacks de ${recursoSel.value}`;
    } else {
      titulo.value = "";
    }
  }

  stacksSel.addEventListener("change", actualizarTitulo);
  recursoSel.addEventListener("change", actualizarTitulo);

  // ==========================
  // CAMBIO ENTRE LOGIN / REGISTRO
  // ==========================
  showRegister.addEventListener("click", (e) => {
    e.preventDefault();
    loginSec.style.display = "none";
    registerSec.style.display = "block";
  });

  showLogin.addEventListener("click", (e) => {
    e.preventDefault();
    registerSec.style.display = "none";
    loginSec.style.display = "block";
  });

  // ==========================
  // REGISTRO CON SUPABASE
  // ==========================
  btnRegister.addEventListener("click", async () => {
    const nombre = regUser.value.trim();
    const email = regEmail.value.trim();
    const pass = regPass.value.trim();

    if (!nombre || !email || !pass) {
      alert("Por favor complet√° todos los campos.");
      return;
    }

    try {
      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password: pass,
        options: {
          data: { nombre }, // se guarda como metadata del usuario
        },
      });

      if (error) {
        console.error(error);
        alert(error.message || "Error al registrar usuario.");
        return;
      }

      alert("Usuario registrado. Ahora pod√©s iniciar sesi√≥n.");
      regUser.value = "";
      regEmail.value = "";
      regPass.value = "";
      registerSec.style.display = "none";
      loginSec.style.display = "block";
    } catch (err) {
      console.error(err);
      alert("Error de conexi√≥n con Supabase.");
    }
  });

  // ==========================
  // LOGIN CON SUPABASE
  // ==========================
  btnLogin.addEventListener("click", async () => {
    // IMPORTANTE: ac√° vamos a usar el campo de login como CORREO
    const email = loginUser.value.trim();
    const pass = loginPass.value.trim();

    if (!email || !pass) {
      alert("Por favor complet√° correo y contrase√±a.");
      return;
    }

    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password: pass,
      });

      if (error) {
        console.error(error);
        alert(error.message || "Error al iniciar sesi√≥n.");
        return;
      }

      // Nombre para mostrar en la app
      const user = data.user;
      const nombreParaMostrar =
        (user.user_metadata && user.user_metadata.nombre) || user.email;

      loggedUser = nombreParaMostrar;
      guardar();

      loginSec.style.display = "none";
      registerSec.style.display = "none";
      appSec.style.display = "block";

      inicializarFormMision();
      actualizarUsuarioLogueadoUI();
      renderMisiones();
      renderCompletadas();
    } catch (err) {
      console.error(err);
      alert("Error de conexi√≥n con Supabase.");
    }
  });

  // ==========================
  // CREAR MISI√ìN
  // ==========================
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!titulo.value) {
      alert("Selecciona stack y recurso");
      return;
    }
    const id = Date.now() + Math.floor(Math.random() * 1000);
    const nueva = {
      id,
      titulo: titulo.value,
      stack: parseInt(stacksSel.value),
      recurso: recursoSel.value,
      oro: parseInt(oroInput.value) || 0,
      autor: loggedUser,
      fecha: new Date().toLocaleDateString(),
      tomadoPor: null,
    };
    misiones.unshift(nueva);
    guardar();
    form.reset();
    titulo.value = "";
    inicializarFormMision();
    renderMisiones();
  });

  // ==========================
  // NAVEGACI√ìN ENTRE SECCIONES
  // ==========================
  const secciones = {
    crear: document.getElementById("crear"),
    ver: document.getElementById("ver"),
    completadas: document.getElementById("completadas"),
  };
  const botones = {
    crear: document.getElementById("btn-crear"),
    ver: document.getElementById("btn-ver"),
    completadas: document.getElementById("btn-completadas"),
  };

  Object.keys(botones).forEach((k) => {
    botones[k].addEventListener("click", () => {
      Object.values(secciones).forEach((s) => s.classList.remove("active"));
      Object.values(botones).forEach((b) => b.classList.remove("active"));
      secciones[k].classList.add("active");
      botones[k].classList.add("active");
      if (k === "ver") renderMisiones();
      if (k === "completadas") renderCompletadas();
    });
  });

  // ==========================
  // RENDERIZAR MISIONES
  // ==========================
  function renderMisiones() {
    listaMisiones.innerHTML = "";
    let visible = [...misiones];

    if (filtroRecurso.value) {
      visible = visible.filter((m) => m.recurso === filtroRecurso.value);
    }

    if (ordenarPorOro) {
      visible.sort((a, b) => b.oro - a.oro);
    }

    if (visible.length === 0) {
      listaMisiones.innerHTML = "<p>No hay misiones activas con esos criterios.</p>";
      return;
    }

    visible.forEach((m) => {
      const total = (recursos[m.recurso] || 0) * m.stack;
      const card = document.createElement("div");
      card.className = "mision" + (m.tomadoPor ? " tomada" : "");
      card.innerHTML = `
        <h3>${m.titulo}</h3>
        <p>üè∑Ô∏è Recurso: ${m.recurso} (${m.stack} stacks = ${total} unidades)</p>
        <p>üìÖ Creada el: ${m.fecha}</p>
        <p>üë§ Autor: ${m.autor}</p>
        ${m.tomadoPor ? `<p>‚öíÔ∏è En curso por: <strong>${m.tomadoPor}</strong></p>` : ""}
      `;

      const btns = document.createElement("div");
      btns.className = "botones-mision";

      if (!m.tomadoPor) {
        const takeBtn = document.createElement("button");
        takeBtn.textContent = "ü™ì Tomar";
        takeBtn.addEventListener("click", () => {
          m.tomadoPor = loggedUser;
          guardar();
          renderMisiones();
        });
        btns.appendChild(takeBtn);
      } else {
        const compBtn = document.createElement("button");
        compBtn.textContent = "‚úÖ Completar";
        compBtn.addEventListener("click", () => {
          completarMisionPorId(m.id);
        });
        btns.appendChild(compBtn);
      }

      const delBtn = document.createElement("button");
      delBtn.textContent = "üóëÔ∏è Borrar";
      delBtn.addEventListener("click", () => {
        if (confirm("¬øBorrar esta misi√≥n?")) {
          misiones = misiones.filter((x) => x.id !== m.id);
          guardar();
          renderMisiones();
        }
      });
      btns.appendChild(delBtn);

      card.appendChild(btns);
      listaMisiones.appendChild(card);
    });
  }

  function completarMisionPorId(id) {
    const idx = misiones.findIndex((x) => x.id === id);
    if (idx === -1) return;
    const m = misiones[idx];
    m.completadaPor = loggedUser;
    completadas.unshift(m);
    misiones.splice(idx, 1);
    guardar();
    renderMisiones();
    renderCompletadas();
  }

  function renderCompletadas() {
    listaCompletadas.innerHTML = "";

    const creadores = [...new Set(completadas.map((m) => m.autor))];
    filtroCreador.innerHTML = '<option value="">Todos los creadores</option>';
    creadores.forEach((c) => {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      filtroCreador.appendChild(o);
    });

    const completadores = [...new Set(completadas.map((m) => m.completadaPor))];
    filtroCompletador.innerHTML =
      '<option value="">Todos los completadores</option>';
    completadores.forEach((c) => {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      filtroCompletador.appendChild(o);
    });

    let visible = [...completadas];
    if (filtroCreador.value) {
      visible = visible.filter((m) => m.autor === filtroCreador.value);
    }
    if (filtroCompletador.value) {
      visible = visible.filter(
        (m) => m.completadaPor === filtroCompletador.value
      );
    }

    if (visible.length === 0) {
      listaCompletadas.innerHTML =
        "<p>No hay misiones completadas con esos criterios.</p>";
      return;
    }

    visible.forEach((m) => {
      const card = document.createElement("div");
      card.className = "mision tomada";
      card.innerHTML = `
        <h3>${m.titulo}</h3>
        <p>üè∑Ô∏è ${m.recurso} (${m.stack} stacks)</p>
        <p>üí∞ ${m.oro} oro</p>
        <p>üë§ Creada por: ${m.autor}</p>
        <p>‚úÖ Completada por: <strong>${m.completadaPor}</strong></p>
      `;
      listaCompletadas.appendChild(card);
    });
  }

  // ==========================
  // FILTROS Y ORDEN
  // ==========================
  filtroRecurso.addEventListener("change", renderMisiones);
  ordenarBtn.addEventListener("click", () => {
    ordenarPorOro = !ordenarPorOro;
    ordenarBtn.textContent = ordenarPorOro
      ? "üîΩ Mostrar todas"
      : "üí∞ Ordenar por recompensa";
    renderMisiones();
  });
  filtroCreador.addEventListener("change", renderCompletadas);
  filtroCompletador.addEventListener("change", renderCompletadas);

  // ==========================
  // CERRAR SESI√ìN
  // ==========================
  async function cerrarSesion() {
    try {
      await supabaseClient.auth.signOut();
    } catch (e) {
      console.error(e);
    }
    loggedUser = null;
    localStorage.removeItem("loggedUser");
    actualizarUsuarioLogueadoUI();
    appSec.style.display = "none";
    loginSec.style.display = "block";
  }

  // la funci√≥n tiene que ser global porque la llam√°s desde el HTML
  window.cerrarSesion = cerrarSesion;

  // ==========================
  // RESET TEMPORAL (DEBUG)
  // ==========================
  window.resetearDatos = function () {
    localStorage.removeItem("misiones");
    localStorage.removeItem("completadas");
    localStorage.removeItem("loggedUser");
    alert(
      "¬°Datos reseteados! Recarga la p√°gina para empezar limpio (no afecta Supabase)."
    );
  };

  // ==========================
  // AL CARGAR LA P√ÅGINA
  // ==========================
  if (loggedUser) {
    // ya hab√≠a alguien logueado en este navegador
    loginSec.style.display = "none";
    registerSec.style.display = "none";
    appSec.style.display = "block";
    inicializarFormMision();
    actualizarUsuarioLogueadoUI();
    renderMisiones();
    renderCompletadas();
  } else {
    // mostrar login por defecto
    loginSec.style.display = "block";
    registerSec.style.display = "none";
    appSec.style.display = "none";
  }
  // ===== MEN√ö DESPLEGABLE DEL USUARIO =====
const userMenuButton = document.getElementById("userMenuButton");
const userMenuDropdown = document.getElementById("userMenuDropdown");
const userNameText = document.getElementById("userNameText");

// Mostrar nombre del usuario logueado
if (loggedUser) {
  userNameText.textContent = loggedUser;
}

// Abrir/cerrar men√∫
userMenuButton.addEventListener("click", () => {
  userMenuDropdown.style.display =
    userMenuDropdown.style.display === "block" ? "none" : "block";
});

// Cerrar el men√∫ si clicke√°s fuera
document.addEventListener("click", (e) => {
  if (!userMenuContainer.contains(e.target)) {
    userMenuDropdown.style.display = "none";
  }
});

// Bot√≥n "Cerrar sesi√≥n"
document.getElementById("menuLogout").addEventListener("click", () => {
  cerrarSesion();
});

// Bot√≥n "Perfil"
document.getElementById("menuPerfil").addEventListener("click", () => {
  alert("Tu perfil estar√° disponible pronto. üòÑ");
});

// Bot√≥n "Historial"
document.getElementById("menuHistorial").addEventListener("click", () => {
  alert("En breve podr√°s ver todas tus misiones creadas y completadas.");
});

</script>
</body>
</html>





