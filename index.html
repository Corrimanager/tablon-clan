<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<link rel="stylesheet" href="style.css"> 
<title>ðŸªµ TablÃ³n del Clan - Pax Dei</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header>
    <h1>ðŸªµ TablÃ³n del Clan - Pax Dei</h1>

    <!-- MENÃš DEL USUARIO (OCULTO HASTA LOGIN) -->
    <div id="userMenuContainer" style="display:none;">
        <div id="userMenuButton">
            <span id="userNameText"></span> â–¼
        </div>
        <div id="userMenuDropdown">
            <button id="menuPerfil">Perfil</button>
            <button id="menuHistorial">Historial de misiones</button>
            <button id="menuLogout">Cerrar sesiÃ³n</button>
        </div>
    </div>
</header>

<!-- ==========================
       LOGIN
=========================== -->
<section id="login" class="active">
    <h2>Login</h2>
    <input type="text" id="loginUser" placeholder="Usuario">
    <input type="password" id="loginPass" placeholder="ContraseÃ±a">
    <button id="btnLogin">Ingresar</button>
    <p>No tienes cuenta? <a href="#" id="showRegister">RegÃ­strate</a></p>
</section>

<!-- ==========================
       REGISTRO
=========================== -->
<section id="register" style="display:none;">
    <h2>Registro</h2>
    <input type="text" id="regUser" placeholder="Usuario">
    <input type="password" id="regPass" placeholder="ContraseÃ±a">
    <input type="email" id="regEmail" placeholder="Correo electrÃ³nico">
    <button id="btnRegister">Registrar</button>
    <p>Ya tienes cuenta? <a href="#" id="showLogin">Volver al login</a></p>
</section>

<!-- ==========================
         APP
=========================== -->
<main id="app" style="display:none;">
    <div id="usuarioLogueado"></div>

    <nav>
        <button id="btn-crear" class="active">âž• Crear MisiÃ³n</button>
        <button id="btn-ver">ðŸ“œ Ver Misiones</button>
        <button id="btn-completadas">âœ… Completadas</button>
    </nav>

    <!-- CREAR MISIÃ“N -->
    <div class="section-wrapper">
        <section id="crear" class="active tab-section">
            <form id="formMision">
                <input type="text" id="titulo" placeholder="TÃ­tulo automÃ¡tico" readonly>

                <label>Recurso necesario:</label>
                <div style="display:flex; gap:10px;">
                    <select id="stacks">
                        <option value="">Stacks</option>
                    </select>
                    <select id="recurso">
                        <option value="">Selecciona un recurso</option>
                    </select>
                </div>

                <input type="number" id="oro" placeholder="Recompensa en oro" required>
                <input type="text" id="autor" placeholder="Tu nombre" readonly>

                <button type="submit" class="submit">ðŸ“œ Agregar misiÃ³n</button>
            </form>
        </section>
    </div>

    <!-- VER MISIÃ“N -->
    <div class="section-wrapper">
        <section id="ver" class="tab-section">
            <h2>Misiones Activas</h2>
            <div class="filtros">
                <select id="filtroRecurso"><option value="">Todos los recursos</option></select>
                <button id="ordenarOro">ðŸ’° Ordenar por recompensa</button>
            </div>
            <div id="listaMisiones"></div>
        </section>
    </div>

    <!-- COMPLETADAS -->
    <div class="section-wrapper">
        <section id="completadas" class="tab-section">
            <h2>Misiones Completadas</h2>
            <div class="filtros">
                <select id="filtroCreador"></select>
                <select id="filtroCompletador"></select>
            </div>
            <div id="listaCompletadas"></div>
        </section>
    </div>
</main>

<!-- ==========================
        SCRIPT
=========================== -->
<script>
/* ---------- CONFIG SUPABASE ---------- */
const SUPABASE_URL = "https://ipwxzkdpgbwgdeflzaks.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwd3h6a2RwZ2J3Z2RlZmx6YWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTQ4NDksImV4cCI6MjA3ODM5MDg0OX0.LwtXhr_AY-6f09thVqaUSiop2YvqEEc4X5Vg1-jZQvQ";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- VARIABLES ---------- */
let misiones = [];
let completadas = [];
let loggedUser = localStorage.getItem("loggedUser") || null;

/* ---------- ELEMENTOS DOM ---------- */
const loginSec = document.getElementById("login");
const registerSec = document.getElementById("register");
const appSec = document.getElementById("app");

const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");

const regUser = document.getElementById("regUser");
const regPass = document.getElementById("regPass");
const regEmail = document.getElementById("regEmail");

const btnLogin = document.getElementById("btnLogin");
const btnRegister = document.getElementById("btnRegister");

const showRegister = document.getElementById("showRegister");
const showLogin = document.getElementById("showLogin");

const userMenuContainer = document.getElementById("userMenuContainer");
const userMenuButton = document.getElementById("userMenuButton");
const userMenuDropdown = document.getElementById("userMenuDropdown");
const userNameText = document.getElementById("userNameText");

/* =====================================================
                 LOGIN / REGISTRO
===================================================== */
btnLogin.addEventListener("click", async () => {
    const user = loginUser.value.trim();
    const pass = loginPass.value.trim();

    const { data, error } = await supabaseClient.auth.signInWithPassword({
        email: user,
        password: pass
    });

    if (error) {
        alert("Usuario o contraseÃ±a incorrectos");
        return;
    }

    loggedUser = user;
    localStorage.setItem("loggedUser", loggedUser);

    userNameText.textContent = loggedUser;
    userMenuContainer.style.display = "block";

    loginSec.style.display = "none";
    appSec.style.display = "block";
});

/* ---------- REGISTRO ---------- */
showRegister.addEventListener("click", e => {
    e.preventDefault();
    loginSec.style.display = "none";
    registerSec.style.display = "block";
});

showLogin.addEventListener("click", e => {
    e.preventDefault();
    registerSec.style.display = "none";
    loginSec.style.display = "block";
});

/* ---------- CERRAR SESIÃ“N ---------- */
document.getElementById("menuLogout").addEventListener("click", async () => {
    await supabaseClient.auth.signOut();

    loggedUser = null;
    localStorage.removeItem("loggedUser");

    userMenuContainer.style.display = "none";
    appSec.style.display = "none";
    loginSec.style.display = "block";
});

/* =====================================================
           OCULTAR MENÃš AL HACER CLICK AFUERA
===================================================== */
userMenuButton.addEventListener("click", () => {
    userMenuDropdown.style.display =
        userMenuDropdown.style.display === "block" ? "none" : "block";
});

document.addEventListener("click", (e) => {
    if (!userMenuContainer.contains(e.target)) {
        userMenuDropdown.style.display = "none";
    }
});

/* =====================================================
         INICIALIZAR STICKS Y RECURSOS
===================================================== */
async function inicializarFormMision() {
    const stacksSel = document.getElementById("stacks");
    const recursoSel = document.getElementById("recurso");
    const filtroRecurso = document.getElementById("filtroRecurso");

    stacksSel.innerHTML = `<option value="">Stacks</option>`;
    for (let i = 1; i <= 36; i++) {
        stacksSel.innerHTML += `<option value="${i}">${i}</option>`;
    }

    recursoSel.innerHTML = `<option value="">Selecciona un recurso</option>`;
    filtroRecurso.innerHTML = `<option value="">Todos los recursos</option>`;

    const { data, error } = await supabaseClient
        .from("recursos")
        .select("*")
        .order("nombre");

    if (!error && data) {
        data.forEach(r => {
            recursoSel.innerHTML += `<option value="${r.nombre}">${r.nombre}</option>`;
            filtroRecurso.innerHTML += `<option value="${r.nombre}">${r.nombre}</option>`;
        });
    }
}

/* =====================================================
             INIT
===================================================== */
(async function init() {
    if (loggedUser) {
        loginSec.style.display = "none";
        appSec.style.display = "block";
        userMenuContainer.style.display = "block";
        userNameText.textContent = loggedUser;
    }

    inicializarFormMision();
})();
</script>

</body>
</html>
