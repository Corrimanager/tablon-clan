<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ðŸªµ TablÃ³n del Clan - Pax Dei</title>

  <!-- CSS externo -->
  <link rel="stylesheet" href="style.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<!-- ============================
     CONFIGURACIÃ“N SUPABASE
============================== -->
<script>
const SUPABASE_URL = "https://ipwxzkdpgbwgdeflzaks.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwd3h6a2RwZ2J3Z2RlZmx6YWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTQ4NDksImV4cCI6MjA3ODM5MDg0OX0.LwtXhr_AY-6f09thVqaUSiop2YvqEEc4X5Vg1-jZQvQ";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>


<!-- ============================
     REDIRECCIÃ“N AL LOGIN SI NO HAY SESIÃ“N
============================== -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const { data } = await supabaseClient.auth.getSession();
    if (!data.session) {
        window.location.href = "login.html";
    }
});
</script>


<!-- ============================
     HEADER + MENÃš DE USUARIO
============================== -->
<header>
    <h1>ðŸ“œ TablÃ³n del Clan - Pax Dei</h1>

    <div id="userMenuContainer" style="display:none;">
        <div id="userMenuButton">
            <span id="userNameText"></span> â–¼
        </div>

        <div id="userMenuDropdown">
            <button id="menuPerfil">ðŸ‘¤ Perfil</button>
            <button id="menuHistorial">ðŸ“œ Historial</button>
            <button id="menuLogout">ðŸšª Cerrar sesiÃ³n</button>
        </div>
    </div>
</header>


<!-- ============================
     ÃREA DE LA APP (solo si logueado)
============================== -->
<main id="app" style="display:none;">

    <nav>
      <button id="btn-crear" class="active">âž• Crear MisiÃ³n</button>
      <button id="btn-ver">ðŸ“œ Ver Misiones</button>
      <button id="btn-completadas">âœ… Completadas</button>
    </nav>

    <!-- CREAR MISIÃ“N -->
    <section id="crear" class="active">
      <form id="formMision">
          <input type="text" id="titulo" placeholder="TÃ­tulo automÃ¡tico" readonly>

          <label>Recurso necesario:</label>
          <div class="fila">
              <select id="stacks"></select>
              <select id="recurso"></select>
          </div>

          <input type="number" id="oro" placeholder="Recompensa en oro">
          <input type="text" id="autor" readonly>

          <button type="submit">ðŸ“œ Agregar misiÃ³n</button>
      </form>
    </section>

    <!-- MISONES ACTIVAS -->
    <section id="ver">
        <h2>Misiones Activas</h2>

        <div class="filtros">
            <select id="filtroRecurso"></select>
            <button id="ordenarOro">ðŸ’° Ordenar por oro</button>
        </div>

        <div id="listaMisiones"></div>
    </section>

    <!-- COMPLETADAS -->
    <section id="completadas">
        <h2>Misiones Completadas</h2>

        <div class="filtros">
            <select id="filtroCreador"></select>
            <select id="filtroCompletador"></select>
        </div>

        <div id="listaCompletadas"></div>
    </section>

</main>


<!-- ============================
     LÃ“GICA PRINCIPAL (SIN LOGIN)
============================== -->
<script>
// Tu lÃ³gica original SIN login integrado.
// Se conserva toda la funcionalidad de misiones.

let misiones = JSON.parse(localStorage.getItem("misiones")) || [];
let completadas = JSON.parse(localStorage.getItem("completadas")) || [];
let loggedUser = localStorage.getItem("loggedUser") || null;

const recursos = { Albura: 50, Arcilla: 100, Juncos: 75, Piedra: 100 };

// ==================
// DOM
// ==================
const appSec = document.getElementById("app");
const userMenuContainer = document.getElementById("userMenuContainer");
const userMenuButton = document.getElementById("userMenuButton");
const userMenuDropdown = document.getElementById("userMenuDropdown");
const userNameText = document.getElementById("userNameText");

const form = document.getElementById("formMision");
const titulo = document.getElementById("titulo");
const stacksSel = document.getElementById("stacks");
const recursoSel = document.getElementById("recurso");
const oroInput = document.getElementById("oro");
const autorInput = document.getElementById("autor");

const listaMisiones = document.getElementById("listaMisiones");
const listaCompletadas = document.getElementById("listaCompletadas");


// ==================
// Mostrar usuario logueado
// ==================
function mostrarUsuario() {
    if (!loggedUser) return;
    userMenuContainer.style.display = "block";
    userNameText.textContent = loggedUser;
}


// ==================
// Inicializar app
// ==================
document.addEventListener("DOMContentLoaded", async () => {
    const { data } = await supabaseClient.auth.getSession();
    if (data.session) {
        loggedUser = data.session.user.email.split("@")[0].toUpperCase();
        localStorage.setItem("loggedUser", loggedUser);

        autorInput.value = loggedUser;
        appSec.style.display = "block";
        mostrarUsuario();

        inicializarForm();
        renderMisiones();
        renderCompletadas();
    }
});


// ==================
// Inicializar formulario
// ==================
function inicializarForm() {
    stacksSel.innerHTML = "<option value=''>Stacks</option>";
    for (let i = 1; i <= 36; i++) {
        stacksSel.innerHTML += `<option value="${i}">${i}</option>`;
    }

    recursoSel.innerHTML = "<option value=''>Selecciona un recurso</option>";
    Object.keys(recursos).forEach(r => {
        recursoSel.innerHTML += `<option value="${r}">${r}</option>`;
    });
}


// ==================
// Crear MisiÃ³n
// ==================
form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!titulo.value) {
        alert("Completa stack y recurso");
        return;
    }

    const nueva = {
        id: Date.now(),
        titulo: titulo.value,
        stack: stacksSel.value,
        recurso: recursoSel.value,
        oro: oroInput.value,
        autor: loggedUser,
        fecha: new Date().toLocaleDateString(),
        tomadoPor: null,
    };

    misiones.unshift(nueva);
    localStorage.setItem("misiones", JSON.stringify(misiones));

    form.reset();
    titulo.value = "";
    inicializarForm();
    renderMisiones();
});


// ==================
// Redirigir desde el menÃº
// ==================
document.getElementById("menuPerfil").onclick = () => {
    window.location.href = "perfil.html";
};
document.getElementById("menuHistorial").onclick = () => {
    window.location.href = "historial.html";
};
document.getElementById("menuLogout").onclick = async () => {
    await supabaseClient.auth.signOut();
    localStorage.clear();
    window.location.href = "login.html";
};
</script>

</body>
</html>
