<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ü™µ Tabl√≥n del Clan - Pax Dei</title>

  <!-- CSS externo -->
  <link rel="stylesheet" href="style.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- Chequeo de sesi√≥n -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
      const { data } = await supabase.auth.getSession();

      if (!data.session) {
          window.location.href = "login.html";
          return;
      }

      // Si est√° logueado, pod√©s cargar el nombre del usuario
      document.getElementById("userMenuText").innerText =
          data.session.user.email.split("@")[0].toUpperCase();
  });
  </script>

  <script>
  // Si el usuario ya tiene sesi√≥n activa EN ESTA PESTA√ëA,
  // lo mando directo al index
  document.addEventListener("DOMContentLoaded", async () => {
      const { data } = await supabase.auth.getSession();
      if (data.session) {
          window.location.href = "index.html";
      }
  });

  // LOGIN
  async function loginUser() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;

      let { error } = await supabase.auth.signInWithPassword({
          email: email,
          password: pass
      });

      if (error) {
          alert("Error al iniciar sesi√≥n: " + error.message);
          return;
      }

      window.location.href = "index.html";
  }
</script>

<!-- FORMULARIO -->
<div>
   <input type="email" id="email" placeholder="Email" />
   <input type="password" id="password" placeholder="Contrase√±a" />
   <button onclick="loginUser()">Ingresar</button>
</div>


  <header>
    <h1>üìú Tabl√≥n del Clan - Pax Dei</h1>

    <!-- MEN√ö DE USUARIO (SOLO SE MUESTRA SI HAY loggedUser) -->
    <div id="userMenuContainer" style="display:none;">
      <div id="userMenuButton">
        <span id="userNameText"></span> ‚ñº
      </div>

      <div id="userMenuDropdown">
        <button id="menuPerfil">üë§ Perfil</button>
        <button id="menuHistorial">üìú Historial de misiones</button>
        <button id="menuLogout">üö™ Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="login" class="active">
    <h2>Login</h2>
    <input type="text" id="loginUser" placeholder="Correo (no usuario)">
    <input type="password" id="loginPass" placeholder="Contrase√±a">
    <button id="btnLogin">Ingresar</button>
    <p>¬øNo tienes cuenta? <a href="#" id="showRegister">Reg√≠strate</a></p>
  </section>

  <!-- REGISTER -->
  <section id="register" style="display:none;">
    <h2>Registro</h2>
    <input type="text" id="regUser" placeholder="Nombre a mostrar">
    <input type="email" id="regEmail" placeholder="Correo electr√≥nico">
    <input type="password" id="regPass" placeholder="Contrase√±a">
    <button id="btnRegister">Registrar</button>
    <p>¬øYa tienes cuenta? <a href="#" id="showLogin">Volver al login</a></p>
  </section>

  <!-- APP -->
  <main id="app" style="display:none;">
    <!-- lo dejo por compatibilidad con tu JS, pero podemos ocultarlo luego -->
    <div id="usuarioLogueado" style="display:none;"></div>

    <nav>
      <button id="btn-crear" class="active">‚ûï Crear Misi√≥n</button>
      <button id="btn-ver">üìú Ver Misiones</button>
      <button id="btn-completadas">‚úÖ Completadas</button>
    </nav>

    <!-- CREAR -->
    <section id="crear" class="active">
      <form id="formMision">
        <input type="text" id="titulo" placeholder="T√≠tulo autom√°tico" readonly>
        <label>Recurso necesario:</label>
        <div style="display:flex; gap:10px;">
          <select id="stacks" style="flex:1;">
            <option value="">Stacks</option>
          </select>
          <select id="recurso" style="flex:2;">
            <option value="">Selecciona un recurso</option>
          </select>
        </div>
        <input type="number" id="oro" placeholder="Recompensa en oro" required>
        <input type="text" id="autor" placeholder="Tu nombre" readonly>
        <button type="submit" class="submit">üìú Agregar misi√≥n</button>
      </form>
    </section>

    <!-- VER -->
    <section id="ver">
      <h2>Misiones Activas</h2>
      <div class="filtros">
        <select id="filtroRecurso">
          <option value="">Todos los recursos</option>
        </select>
        <button id="ordenarOro">üí∞ Ordenar por recompensa</button>
      </div>
      <div id="listaMisiones"></div>
    </section>

    <!-- COMPLETADAS -->
    <section id="completadas">
      <h2>Misiones Completadas</h2>
      <div class="filtros">
        <select id="filtroCreador"></select>
        <select id="filtroCompletador"></select>
      </div>
      <div id="listaCompletadas"></div>
    </section>
  </main>

  <!-- JS PRINCIPAL -->
  <script>
    // ==========================
    // CONFIGURACI√ìN SUPABASE
    // ==========================
    const SUPABASE_URL = "https://ipwxzkdpgbwgdeflzaks.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlwd3h6a2RwZ2J3Z2RlZmx6YWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTQ4NDksImV4cCI6MjA3ODM5MDg0OX0.LwtXhr_AY-6f09thVqaUSiop2YvqEEc4X5Vg1-jZQvQ";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==========================
    // DATOS EN LOCALSTORAGE
    // ==========================
    const recursos = { Albura: 50, Arcilla: 100, Juncos: 75, Piedra: 100 };

    let misiones = JSON.parse(localStorage.getItem("misiones")) || [];
    let completadas = JSON.parse(localStorage.getItem("completadas")) || [];
    let loggedUser = localStorage.getItem("loggedUser") || null;

    // ==========================
    // REFERENCIAS AL DOM
    // ==========================
    const loginSec = document.getElementById("login");
    const registerSec = document.getElementById("register");
    const appSec = document.getElementById("app");

    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const regUser = document.getElementById("regUser");
    const regPass = document.getElementById("regPass");
    const regEmail = document.getElementById("regEmail");
    const btnLogin = document.getElementById("btnLogin");
    const btnRegister = document.getElementById("btnRegister");
    const showRegister = document.getElementById("showRegister");
    const showLogin = document.getElementById("showLogin");
    const usuarioLogueadoDiv = document.getElementById("usuarioLogueado");

    const form = document.getElementById("formMision");
    const titulo = document.getElementById("titulo");
    const stacksSel = document.getElementById("stacks");
    const recursoSel = document.getElementById("recurso");
    const oroInput = document.getElementById("oro");
    const autorInput = document.getElementById("autor");
    const filtroRecurso = document.getElementById("filtroRecurso");
    const ordenarBtn = document.getElementById("ordenarOro");
    const listaMisiones = document.getElementById("listaMisiones");
    const listaCompletadas = document.getElementById("listaCompletadas");
    const filtroCreador = document.getElementById("filtroCreador");
    const filtroCompletador = document.getElementById("filtroCompletador");

    let ordenarPorOro = false;

    // Men√∫ usuario
    const userMenuContainer = document.getElementById("userMenuContainer");
    const userMenuButton = document.getElementById("userMenuButton");
    const userMenuDropdown = document.getElementById("userMenuDropdown");
    const userNameText = document.getElementById("userNameText");
    const menuPerfil = document.getElementById("menuPerfil");
    const menuHistorial = document.getElementById("menuHistorial");
    const menuLogout = document.getElementById("menuLogout");

    // ==========================
    // UTILIDADES GENERALES
    // ==========================
    function guardar() {
      localStorage.setItem("misiones", JSON.stringify(misiones));
      localStorage.setItem("completadas", JSON.stringify(completadas));
      localStorage.setItem("loggedUser", loggedUser);
    }

    function actualizarUsuarioLogueadoUI() {
      if (loggedUser) {
        if (usuarioLogueadoDiv) {
          usuarioLogueadoDiv.textContent = "Usuario: " + loggedUser;
        }
        if (userMenuContainer) {
          userMenuContainer.style.display = "block";
        }
        if (userNameText) {
          userNameText.textContent = loggedUser;
        }
      } else {
        if (usuarioLogueadoDiv) {
          usuarioLogueadoDiv.textContent = "";
        }
        if (userMenuContainer) {
          userMenuContainer.style.display = "none";
        }
        if (userNameText) {
          userNameText.textContent = "";
        }
      }
    }

    function inicializarFormMision() {
      // Stacks
      stacksSel.innerHTML = '<option value="">Stacks</option>';
      for (let i = 1; i <= 36; i++) {
        const o = document.createElement("option");
        o.value = i;
        o.textContent = i;
        stacksSel.appendChild(o);
      }

      // Recursos
      recursoSel.innerHTML = '<option value="">Selecciona un recurso</option>';
      Object.keys(recursos).forEach((r) => {
        const o = document.createElement("option");
        o.value = r;
        o.textContent = r;
        recursoSel.appendChild(o);

        // tambi√©n al filtro
        if (!Array.from(filtroRecurso.options).some((opt) => opt.value === r)) {
          filtroRecurso.appendChild(o.cloneNode(true));
        }
      });

      autorInput.value = loggedUser || "";
    }

    function actualizarTitulo() {
      if (stacksSel.value && recursoSel.value) {
        titulo.value = "Recolectar " + stacksSel.value + " stacks de " + recursoSel.value;
      } else {
        titulo.value = "";
      }
    }

    stacksSel.addEventListener("change", actualizarTitulo);
    recursoSel.addEventListener("change", actualizarTitulo);

    // ==========================
    // CAMBIO ENTRE LOGIN / REGISTRO
    // ==========================
    showRegister.addEventListener("click", (e) => {
      e.preventDefault();
      loginSec.style.display = "none";
      registerSec.style.display = "block";
    });

    showLogin.addEventListener("click", (e) => {
      e.preventDefault();
      registerSec.style.display = "none";
      loginSec.style.display = "block";
    });

    // ==========================
    // REGISTRO CON SUPABASE
    // ==========================
    btnRegister.addEventListener("click", async () => {
      const nombre = regUser.value.trim();
      const email = regEmail.value.trim();
      const pass = regPass.value.trim();

      if (!nombre || !email || !pass) {
        alert("Por favor complet√° todos los campos.");
        return;
      }

      try {
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password: pass,
          options: {
            data: { nombre },
          },
        });

        if (error) {
          console.error(error);
          alert(error.message || "Error al registrar usuario.");
          return;
        }

        alert("Usuario registrado. Revis√° tu mail para confirmar y luego inici√° sesi√≥n.");
        regUser.value = "";
        regEmail.value = "";
        regPass.value = "";
        registerSec.style.display = "none";
        loginSec.style.display = "block";
      } catch (err) {
        console.error(err);
        alert("Error de conexi√≥n con Supabase.");
      }
    });

    // ==========================
    // LOGIN CON SUPABASE
    // ==========================
    btnLogin.addEventListener("click", async () => {
      const email = loginUser.value.trim();
      const pass = loginPass.value.trim();

      if (!email || !pass) {
        alert("Por favor complet√° correo y contrase√±a.");
        return;
      }

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password: pass,
        });

        if (error) {
          console.error(error);
          alert(error.message || "Error al iniciar sesi√≥n.");
          return;
        }

        const user = data.user;
        const nombreParaMostrar =
          (user.user_metadata && user.user_metadata.nombre) || user.email;

        loggedUser = nombreParaMostrar;
        guardar();

        loginSec.style.display = "none";
        registerSec.style.display = "none";
        appSec.style.display = "block";

        inicializarFormMision();
        actualizarUsuarioLogueadoUI();
        renderMisiones();
        renderCompletadas();
      } catch (err) {
        console.error(err);
        alert("Error de conexi√≥n con Supabase.");
      }
    });

    // ==========================
    // CREAR MISI√ìN
    // ==========================
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!titulo.value) {
        alert("Selecciona stack y recurso");
        return;
      }
      const id = Date.now() + Math.floor(Math.random() * 1000);
      const nueva = {
        id,
        titulo: titulo.value,
        stack: parseInt(stacksSel.value),
        recurso: recursoSel.value,
        oro: parseInt(oroInput.value) || 0,
        autor: loggedUser,
        fecha: new Date().toLocaleDateString(),
        tomadoPor: null,
      };
      misiones.unshift(nueva);
      guardar();
      form.reset();
      titulo.value = "";
      inicializarFormMision();
      renderMisiones();
    });

    // ==========================
    // NAVEGACI√ìN ENTRE SECCIONES
    // ==========================
    const secciones = {
      crear: document.getElementById("crear"),
      ver: document.getElementById("ver"),
      completadas: document.getElementById("completadas"),
    };
    const botones = {
      crear: document.getElementById("btn-crear"),
      ver: document.getElementById("btn-ver"),
      completadas: document.getElementById("btn-completadas"),
    };

    Object.keys(botones).forEach((k) => {
      botones[k].addEventListener("click", () => {
        Object.values(secciones).forEach((s) => s.classList.remove("active"));
        Object.values(botones).forEach((b) => b.classList.remove("active"));
        secciones[k].classList.add("active");
        botones[k].classList.add("active");
        if (k === "ver") renderMisiones();
        if (k === "completadas") renderCompletadas();
      });
    });

    // ==========================
    // RENDERIZAR MISIONES
    // ==========================
    function renderMisiones() {
      listaMisiones.innerHTML = "";
      let visible = [...misiones];

      if (filtroRecurso.value) {
        visible = visible.filter((m) => m.recurso === filtroRecurso.value);
      }

      if (ordenarPorOro) {
        visible.sort((a, b) => b.oro - a.oro);
      }

      if (visible.length === 0) {
        listaMisiones.innerHTML = "<p>No hay misiones activas con esos criterios.</p>";
        return;
      }

      visible.forEach((m) => {
        const total = (recursos[m.recurso] || 0) * m.stack;
        const card = document.createElement("div");
        card.className = "mision" + (m.tomadoPor ? " tomada" : "");
        card.innerHTML = `
          <h3>${m.titulo}</h3>
          <p>üè∑Ô∏è Recurso: ${m.recurso} (${m.stack} stacks = ${total} unidades)</p>
          <p>üìÖ Creada el: ${m.fecha}</p>
          <p>üë§ Autor: ${m.autor}</p>
          ${m.tomadoPor ? `<p>‚öíÔ∏è En curso por: <strong>${m.tomadoPor}</strong></p>` : ""}
        `;

        const btns = document.createElement("div");
        btns.className = "botones-mision";

        if (!m.tomadoPor) {
          const takeBtn = document.createElement("button");
          takeBtn.textContent = "ü™ì Tomar";
          takeBtn.addEventListener("click", () => {
            m.tomadoPor = loggedUser;
            guardar();
            renderMisiones();
          });
          btns.appendChild(takeBtn);
        } else {
          const compBtn = document.createElement("button");
          compBtn.textContent = "‚úÖ Completar";
          compBtn.addEventListener("click", () => {
            completarMisionPorId(m.id);
          });
          btns.appendChild(compBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è Borrar";
        delBtn.addEventListener("click", () => {
          if (confirm("¬øBorrar esta misi√≥n?")) {
            misiones = misiones.filter((x) => x.id !== m.id);
            guardar();
            renderMisiones();
          }
        });
        btns.appendChild(delBtn);

        card.appendChild(btns);
        listaMisiones.appendChild(card);
      });
    }

    function completarMisionPorId(id) {
      const idx = misiones.findIndex((x) => x.id === id);
      if (idx === -1) return;
      const m = misiones[idx];
      m.completadaPor = loggedUser;
      completadas.unshift(m);
      misiones.splice(idx, 1);
      guardar();
      renderMisiones();
      renderCompletadas();
    }

    function renderCompletadas() {
      listaCompletadas.innerHTML = "";

      const creadores = [...new Set(completadas.map((m) => m.autor))];
      filtroCreador.innerHTML = '<option value="">Todos los creadores</option>';
      creadores.forEach((c) => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        filtroCreador.appendChild(o);
      });

      const completadores = [...new Set(completadas.map((m) => m.completadaPor))];
      filtroCompletador.innerHTML =
        '<option value="">Todos los completadores</option>';
      completadores.forEach((c) => {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        filtroCompletador.appendChild(o);
      });

      let visible = [...completadas];
      if (filtroCreador.value) {
        visible = visible.filter((m) => m.autor === filtroCreador.value);
      }
      if (filtroCompletador.value) {
        visible = visible.filter(
          (m) => m.completadaPor === filtroCompletador.value
        );
      }

      if (visible.length === 0) {
        listaCompletadas.innerHTML =
          "<p>No hay misiones completadas con esos criterios.</p>";
        return;
      }

      visible.forEach((m) => {
        const card = document.createElement("div");
        card.className = "mision tomada";
        card.innerHTML = `
          <h3>${m.titulo}</h3>
          <p>üè∑Ô∏è ${m.recurso} (${m.stack} stacks)</p>
          <p>üí∞ ${m.oro} oro</p>
          <p>üë§ Creada por: ${m.autor}</p>
          <p>‚úÖ Completada por: <strong>${m.completadaPor}</strong></p>
        `;
        listaCompletadas.appendChild(card);
      });
    }

    // ==========================
    // CERRAR SESI√ìN
    // ==========================
    async function cerrarSesion() {
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.error(e);
      }
      loggedUser = null;
      localStorage.removeItem("loggedUser");
      actualizarUsuarioLogueadoUI();
      appSec.style.display = "none";
      loginSec.style.display = "block";
      registerSec.style.display = "none";
    }

    // ==========================
    // MEN√ö DE USUARIO
    // ==========================
    userMenuButton.addEventListener("click", (e) => {
      e.stopPropagation();
      userMenuDropdown.style.display =
        userMenuDropdown.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", (e) => {
      if (!userMenuContainer.contains(e.target)) {
        userMenuDropdown.style.display = "none";
      }
    });

    menuPerfil.addEventListener("click", () => {
      window.location.href = "perfil.html";
    });

    menuHistorial.addEventListener("click", () => {
      window.location.href = "historial.html";
    });

    menuLogout.addEventListener("click", () => {
      cerrarSesion();
    });

    // ==========================
    // AL CARGAR LA P√ÅGINA
    // ==========================
    if (loggedUser) {
      loginSec.style.display = "none";
      registerSec.style.display = "none";
      appSec.style.display = "block";
      inicializarFormMision();
      actualizarUsuarioLogueadoUI();
      renderMisiones();
      renderCompletadas();
    } else {
      loginSec.style.display = "block";
      registerSec.style.display = "none";
      appSec.style.display = "none";
      actualizarUsuarioLogueadoUI(); // asegura que el men√∫ est√© oculto
    }
  </script>
</body>
</html>
